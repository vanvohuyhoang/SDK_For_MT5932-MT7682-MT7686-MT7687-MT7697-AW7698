<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>Example projects and demos: ble_mesh_switch</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="airoha.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Example projects and demos
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="modules.html"><span>Project&#160;user's&#160;guide</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('group__aw7698__evk__apps__ble__mesh__switch.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">ble_mesh_switch<div class="ingroups"><a class="el" href="group__aw7698__evk.html">aw7698_evk</a> &raquo; <a class="el" href="group__aw7698__evk__apps.html">apps</a></div></div>  </div>
</div><!--header-->
<div class="contents">
<dl class="section user"><dt>Overview</dt><dd><ul>
<li>Application description<ul>
<li>This is a reference application to demonstrate the Bluetooth mesh switch and Wi-Fi gateway features of the AW7698 EVK through the following:<ul>
<li>How to use the Bluetooth mesh and Wi-Fi gateway functions.</li>
</ul>
</li>
</ul>
</li>
<li>Application features<ul>
<li>Act as a Wi-Fi station to connect to a Wi-Fi network.</li>
<li>Act as a Bluetooth low-energy (LE) device with mesh features. All Bluetooth Mesh Command Line Interface (CLI) commands are supported in this project.</li>
</ul>
</li>
</ul>
</dd></dl>
<dl class="section user"><dt>Hardware and software environment</dt><dd><ul>
<li>Supported platform<ul>
<li>Airoha AW7698 EVK</li>
</ul>
</li>
<li>EVK switches and pin configuration<ul>
<li>J36 provides the pins for GPIOs, PWMs, SPI master chip select 0, SPI master, and UART1 RX/TX.</li>
<li>J35 provides the pins for GPIOs, PWMs, UART2 RX/TX, UART1 RTS/CTS, SPI master chip select 1, IR TX, and IR RX.</li>
<li>J34 provides the pins for GPIOs, PWMs, UART2 RTS/CTS, I2S, SPI slave, and I2C0.</li>
<li>J33 provides the pins for GPIOs, PWMs, I2C0, and ADC0~3.</li>
<li>J32 provides the pins for GND, 5V, 3.3V, and the reset pin.</li>
<li>J25 sets the EVK to either Flash Normal mode or Flash Recovery mode. To update the firmware on the AW7698 EVK:<ul>
<li>Set the jumper J25 to FLASH Recovery mode. Jumpers J23, J26, J27, and J30 must be on.</li>
<li>In this mode, if the power is on, the board loads the ROM code and starts the ATE Daemon or Firmware Upgrade Daemon according to the MT76x7 Flash Tool's behavior on the PC. To run the project on the AW7698 EVK:</li>
<li>Set the jumper J25 off to switch to FLASH Normal mode. Jumpers J23, J26, J27, and J30 must be on.</li>
<li>In this mode, if the power is on, the board loads the firmware from the flash and reboots.</li>
</ul>
</li>
<li>There are three buttons on the board:<ul>
<li>RST - Reset</li>
<li>EINT - External interrupt</li>
<li>RTC_INT - RTC interrupt</li>
</ul>
</li>
</ul>
</li>
<li>Environment configuration<ul>
<li>A serial tool is necessary for UART logging.</li>
<li>COM port settings -baudrate: 115200, data bits: 8, stop bit: 1, parity: none, and flow control: off.</li>
</ul>
</li>
</ul>
</dd></dl>
<dl class="section user"><dt>Directory contents</dt><dd><ul>
<li>This file<ul>
<li><b>readme.txt</b>. Overview of the project</li>
</ul>
</li>
<li>Source and header files<ul>
<li><b>use</b> files in ble_mesh_vendor_device project. All the files are used except the file mesh_app_vendor_device.c, mesh_app_vendor_device_msg_handler.c and mesh_app_vendor_device_pwm.c.</li>
</ul>
</li>
<li>Project configuration files using GCC<ul>
<li><b>GCC/Makefile</b>.: GNU Makefile for this project</li>
</ul>
</li>
</ul>
</dd></dl>
<dl class="section user"><dt>Run the application</dt><dd><ul>
<li>Build the example project with the command "./build.sh aw7698_evk
    ble_mesh_switch" from the SDK root folder and download the binary file to the AW7698 development board.</li>
<li>Reboot the EVK. The console shows the "FreeRTOS Running" message to indicate that the EVK is booting up.</li>
<li>Use '?' and ENTER to query the available command line options. Note that the command line options are still under development and subject to change without notice.</li>
<li>Reference applications run the AW7698 EVK as a Wi-Fi station and acts as a provisioner to add other mesh devices to the mesh network via Bluetooth LE.</li>
<li>Example 1. Wi-Fi station mode<ul>
<li>Find your Wi-Fi access point settings: Before connecting to a Wi-Fi access point, the following information must be collected: 1. The SSID of your Wi-Fi access point. 2. The authentication mode of your Wi- Fi access point. The authentication mode is usualy WPA PSK or WPA2 PSK. To change the mode, please refer to Table 1 for the list of supported authentication modes. 3. The password of your Wi-Fi access point. 4. The encryption mode of your Wi-Fi access point (AES or TKIP is usually used). To change the mode, please refer to Table 2 for the list of supported encryption modes.</li>
<li>When the information is collected, use the following commands to configure the AW7698 EVK. The example code in main.c assumes that either WPA PSK or WPA2 PSK is used for authentication, TKIP or AES is used for encryption, 'myhome' (length 6) is used for the SSID, and the WPA or WPA2 password is '12345678' (length 8). <div class="fragment"><div class="line">config write STA AuthMode 9</div><div class="line">config write STA EncrypType 8</div><div class="line">config write STA Ssid myhome</div><div class="line">config write STA SsidLen 6</div><div class="line">config write STA WpaPsk 12345678</div><div class="line">config write STA WpaPskLen 8</div><div class="line">config write common OpMode 1</div></div><!-- fragment --> press the RESET button on the AW7698 EVK to restart the system.</li>
<li>Boot up with the new configuration. If everything is correct, the same messages are shown in the console to tell you that the EVK has received an IP address. <div class="fragment"><div class="line">DHCP got IP:10.10.10.101</div></div><!-- fragment --></li>
<li>PING from the AW7698 EVK (SDK v3.1.0) If the IP address is fetched and the network is operating, AW7698 can ping other devices on the network with the following command in the console. <div class="fragment"><div class="line">ping 10.10.10.254 3 64</div><div class="line">The ping stops after sending three packets to 10.10.10.254.</div><div class="line">The ping usage is: ping &lt;ip address&gt; &lt;times&gt; &lt;ping packet length&gt;</div></div><!-- fragment --></li>
<li>Wi-Fi configuration options for AuthMode and EncrypType. <div class="fragment"><div class="line">+---+-------------------------------------+</div><div class="line">| 0 | Open(i.e. no security)              |</div><div class="line">+---+-------------------------------------+</div><div class="line">| 4 | WPA PSK                             |</div><div class="line">+---+-------------------------------------+</div><div class="line">| 7 | WPA2 PSK                            |</div><div class="line">+---+-------------------------------------+</div><div class="line">| 9 | Support <span class="keywordflow">for</span> both WPA and WPA2 PSK   |</div><div class="line">+---+-------------------------------------+</div><div class="line">Table 1. Supported AuthMode(s)</div><div class="line">+---+---------------------------------+</div><div class="line">| 0 | WEP                             |</div><div class="line">+---+---------------------------------+</div><div class="line">| 1 | No encryption                   |</div><div class="line">+---+---------------------------------+</div><div class="line">| 4 | TKIP                            |</div><div class="line">+---+---------------------------------+</div><div class="line">| 6 | AES                             |</div><div class="line">+---+---------------------------------+</div><div class="line">| 8 | Support <span class="keywordflow">for</span> both TKIP and AES   |</div><div class="line">+---+---------------------------------+</div><div class="line">Table 2. Supported EncrypType(s)</div></div><!-- fragment --></li>
</ul>
</li>
<li>Example 2. Using the BLE mesh feature<ul>
<li>This example creates a BLE mesh device with one mesh element in which there are 14 models:<ul>
<li>configuration server model;</li>
<li>health server model;</li>
<li>vendor model;</li>
<li>configuration client model;</li>
<li>health client model;</li>
<li>generic on/off client model;</li>
<li>generic level client model;</li>
<li>lightness client model;</li>
<li>CTL client model;</li>
<li>HSL client model;</li>
<li>OTA object transfer client model;</li>
<li>OTA firmware distribution server model;</li>
<li>OTA firmware update client model;</li>
<li>OTA firmware distribution client model.</li>
</ul>
</li>
<li>The mesh feature is enabled after Bluetooth powers on successfully. A similar log is written to the output: <div class="fragment"><div class="line">[T: xxxx M: mesh_app C: info F: bt_mesh_app_event_callback L: 272]: BLE_MESH_EVT_INIT_DONE</div></div><!-- fragment --></li>
<li>It supports PB-ADV and PB-GATT bearers to provision a device to a network.<ul>
<li>PB-ADV Provision<ul>
<li>Input the command "mesh config addr [device address]" on the serial tool to assign the address for the primary mesh element. For example, "mesh config addr 0001".</li>
<li>Input the command "mesh config iv [ivindex] 0" on the serial tool to initiate the IV index for the network. For example, "mesh config iv 0 0".</li>
<li>Input the command "mesh key add net [netkey] [netkey index]" on the serial tool to add the netkey to the mesh stack. This is used when creating a network.<ul>
<li>netkey, a random number with 16 bytes.</li>
<li>netkey index, assign an index for the above netkey, starting at 0.</li>
<li>For example, "mesh key add net 12345678901234567890123456789012 0".</li>
</ul>
</li>
<li>Input the command "mesh key add app [appkey] [appkey index] [netkey index]" on the serial tool to add the app key to the mesh stack.<ul>
<li>appkey, random number with 16 bytes.</li>
<li>appkey index, is currently 0x123 in this project.</li>
<li>netkey index, same as the one above.</li>
<li>For example, "mesh key add app 63964771734fbd76e3b40519d1d94a48 0x123 0".</li>
</ul>
</li>
<li>Input the command "mesh config bind" on the serial tool to bind the vendor model/config model with app key index "0x123".</li>
<li>Create a network Input the command "mesh prov run [remote device UUID] [netkey] [netkey index] [ivindex] [address] [flags]" on the serial tool to add the specific mesh device to the mesh network.<ul>
<li>device UUID of vendor device, 16-bytes.</li>
<li>netkey, the same netkey when input "mesh key add net".</li>
<li>netkey index, the same netkey when input "mesh key add net".</li>
<li>ivindex, usually use 0.</li>
<li>address, 2 bytes, the address assigned to the specific mesh device when it is successfully added to the network.</li>
<li>flags, indicate current states of IV update and key refresh. Usually use 0.</li>
<li>For example "mesh prov run 04112233445566778899aabbccddeeff 12345678901234567890123456789012 0 0 0004 0".</li>
</ul>
</li>
</ul>
</li>
<li>PB-GATT Provision<ul>
<li>Input the command "mesh config addr [device address]" on the serial tool to assign the address for the primary mesh element. For example, "mesh config addr 0015".</li>
<li>Input the command "mesh config iv [ivindex] 0" on the serial tool to initiate the IV index for the network. For example, "mesh config iv 0 0".</li>
<li>Input the command "mesh key add net [netkey] [netkey index]" on the serial tool to add the netkey to the mesh stack. This is used when creating a network.<ul>
<li>netkey, random number with 16 bytes.</li>
<li>netkey index, assign an index for the above netkey, starting at 0.</li>
<li>For example, "mesh key add net 12345678901234567890123456789012 0".</li>
</ul>
</li>
<li>Input the command "mesh key add app [appkey] [appkey index] [netkey index]" on the serial tool to add the app key to the mesh stack.<ul>
<li>appkey, random number with 16 bytes.</li>
<li>appkey index, is currently 0x123 in this project.</li>
<li>netkey index, same as the one above.</li>
<li>for example, "mesh key add app 63964771734fbd76e3b40519d1d94a48 0x123 0".</li>
</ul>
</li>
<li>Input the command "mesh config bind" in the serial tool to bind the vendor model/config model with app key index "0x123".</li>
<li>Create a network.<ul>
<li>Firstly, input the command "mesh prov init [netkey] [netkey index] [ivindex] [address] [flags]" on the serial tool to add the specific mesh device to the mesh network.<ul>
<li>netkey, the same netkey when input "mesh key add net".</li>
<li>netkey index, the same netkey when input "mesh key add net".</li>
<li>ivindex, usually use 0.</li>
<li>address, 2 bytes, the address assigned to the specific mesh device when it is successfully added to the network.</li>
<li>flags, indicate current states of IV update and key refresh. Usually use 0.</li>
<li>For example "mesh prov init 12345678901234567890123456789012 0 0 0014 0".</li>
</ul>
</li>
<li>Then, input the command "mesh gatt connect [addr type] [remote bluetooth addr] [service type]" on the serial tool to create a Mesh GATT connection.<ul>
<li>addr type, the address type of [remote bluetooth addr]. 0 = a public address, 1 = a random address.</li>
<li>remote bluetooth addr, the Bluetooth address of the remote device when advertising.</li>
<li>service type, 0 means proxy, 1 means provision.</li>
<li>For example, "mesh gatt connect 0 C6:29:AB:B7:48:25 1".</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>When the provisioning is complete, the log shows "BLE_MESH_EVT_PROV_DONE SUCCESS" or "BLE_MESH_EVT_PROV_DONE FAILED".</li>
<li>Then, some configuration processes will automatically run, incluing Get composition data, Add appkey, and Model Application binding. When the configuration is complete, the log shows "no more model, all model binding is done"</li>
<li>When the above procedure is complete, the provision and configuration processes are done, then we can test the detail features by sending messages on the serial tool. For example, input the command "mesh msg onoff set [dst_addr] [onoff] [reliable] [ttl]" to use advertising to turn on/off each light with a target address.</li>
</ul>
</li>
<li>dst_addr, is the destination address.</li>
<li>OnOff, the target value if it is in the Generic OnOff state.</li>
<li>reliable, is to send the request as an acknowledged message or not.</li>
<li>ttl, is the received TTL value.</li>
<li>For example, send "mesh msg onoff set 0014 1 1 5".<ul>
<li>To delete the mesh data of all nodes and the local device, use the command "mesh delete". It takes effect after rebooting again. It does not delete the mesh data in those nodes which cannot receive the Node Reset message, but the data of the node in the local device will be deleted after retrying five times without any response from the specific node.</li>
<li>For more information about other commands, please refer to the cmds[] structure in the mesh_app_switch.c file.</li>
</ul>
</li>
</ul>
</li>
<li>Example 3. Using the BLE mesh/wifi gateway feature<ul>
<li>This example allows the AW7698 EVK to act as a gateway to send the Wi-Fi data to a BLE mesh device.</li>
<li>With the procedure in the Example 1, the AW7698 EVK is connected to the laptop via WI-FI and has an IP address.</li>
<li>Connect the laptop to the AW7698 EVK via Telnet. Use the Telnet protocol with port 23 to connect to the IP address of the AW7698 EVK.</li>
<li>Then Input the commands in Example 2 to complete the network configuration and creation.</li>
</ul>
</li>
<li>Example 4. Using the BLE mesh OTA feature.<ul>
<li>The mesh OTA feature is an Airoha proprietary feature based on Bluetooth specification "Mesh Firware Update proposal v05r05". It only supports initiator and distributor, but does not support updator.</li>
<li>This example allows the AW7698 EVK to act as an initiator and distributor of the OTA.</li>
<li>As an initiator and distributor, the user must implement the callback function in the bt_mesh_ota_distributor_new_firmware_t. For more information, please refer to the example file "mesh_app_switch_firmware_callbacks.c".</li>
<li>The network configuration and creation process is complete when you complete the procedure shown in Example 2.</li>
<li>Input the command "mesh config subscribe 0 [dst_addr] [element_addr] [group_addr] 0xff00" on the serial tool to configure the subscription list on the peer nodes to subscribe to the OTA model 0xff00 using the specific group address. Input the command "mesh config subscribe 0 [dst_addr] [element_addr] [group_addr] 0xfe00" on the serial tool to configure the subscription list on the peer nodes to subscribe to the OTA model 0xfe00 using the specific group address.<ul>
<li>0, is the "add" action.</li>
<li>dst_addr, is the address of the primary element in the destination node.</li>
<li>element_addr, the address of the element to which the model ID belongs.</li>
<li>group_addr, is the group address for the subscription.</li>
<li>0xff00, is the model ID of object transfer server model.</li>
<li>0xfe00, is the model ID of firmware update server model.</li>
<li>For example, send "mesh config subscribe 0 0x0010 0x0011 0xc000 0xff00".</li>
</ul>
</li>
<li>Input the command "mesh dist start auto/manual [firmware_id] [distributor_addr] [group_addr] [node1_addr] [node2_addr2]... [noden_addr]" (n is less than 30) on the serial tool to start the OTA.<ul>
<li>"auto" means that application will start automaticly when the transfer is complete; "manual" means that the user must manually apply when the transfer is complete.</li>
<li>firmware_id, is the firmware ID to distinguish between different firmware binaries of the same product.</li>
<li>distributor_addr, is the address of the primary element of the OTA distributor.</li>
<li>group_addr, is the group address for the subscription.</li>
<li>nodex_addr, is the address of the primary element of the node x to update the firmware.</li>
<li>For example, send "mesh dist start auto 0xaabbccdd 0x0001 0xc000 0x0010".</li>
<li>This command can be queued in the mesh stack if the command is input repeatedly and the heap memory is enough for the operation.</li>
</ul>
</li>
<li>Input the command "mesh dist apply" on the serial tool to apply the firmware if the user uses "mesh dist start manual.." in the previous command. </li>
</ul>
</li>
</ul>
</dd></dl>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Tue Apr 30 2019 17:46:48 for Example projects and demos by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.11 </li>
  </ul>
</div>
</body>
</html>
